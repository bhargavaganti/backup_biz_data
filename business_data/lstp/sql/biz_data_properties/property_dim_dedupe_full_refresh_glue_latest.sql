WITH edw_properties AS
(
select
row_number() OVER (PARTITION BY propertyid ORDER BY  cast(propertydimkey as bigint)  DESC) AS row_number_seq,
propertydimkey,
propertyid,
propertytype,
propertyyearbuilt,
propertysquarefeet,
propertylotsquarefeet,
propertyaddress,
propertycity,
propertystate,
propertypostalcode,
propertylatitude,
propertylongitude,
propertynumberofbedrooms,
propertynumberofbathrooms,
propertynumberofstories,
propertyarchitecturestyle,
propertytaxassessedvalue,
propertytaxyear,
propertytaxpaidamount,
propertyzoning,
propertyestimatedvalue,
isforeclosure,
propertyforeclosuredate,
propertylastsaledate,
propertylastsaleprice,
effectivefrom,
effectiveto,
propertycountry,
macroneighborhood,
neighborhood,
subneighborhood,
residentialneighborhood,
etl_ztg_id,
etl_source_partition_timestamp,
etl_create_date,
etl_last_update_timestamp,
etl_partition_key_timestamp,
etl_rd_arrival_year,
etl_rd_arrival_month,
etl_rd_arrival_day,
etl_rd_arrival_hour,
etl_source_filename,
etl_invalid_criticality_ind,
etl_dedupe_md5_checksum,
etl_datatype_processed_ind,
property_latitude_double,
property_longitude_double,
property_number_of_bathrooms_double,
property_number_of_stories_double,
property_tax_assessed_value_double,
property_tax_paid_amount_double,
property_estimated_value_double,
property_foreclosure_datetime,
property_last_sale_datetime,
property_last_sale_price_double,
effective_from_datetime_mst,
effective_to_datetime_mst
from
lstp_edw_pdt__property_dim
)
SELECT
edw_properties.etl_create_date,
edw_properties.etl_datatype_processed_ind,
edw_properties.etl_dedupe_md5_checksum,
edw_properties.etl_invalid_criticality_ind,
edw_properties.etl_last_update_timestamp,
edw_properties.etl_partition_key_timestamp,
edw_properties.etl_rd_arrival_day,
edw_properties.etl_rd_arrival_hour,
edw_properties.etl_rd_arrival_month,
edw_properties.etl_rd_arrival_year,
edw_properties.etl_source_filename,
edw_properties.etl_source_partition_timestamp,
edw_properties.etl_ztg_id,
edw_properties.isforeclosure is_foreclosure,
edw_properties.macroneighborhood macro_neighborhood,
edw_properties.effective_from_datetime_mst mst_effective_from_datetime,
edw_properties.effective_to_datetime_mst mst_effective_to_datetime,
edw_properties.property_foreclosure_datetime mst_property_foreclosure_datetime,
edw_properties.property_last_sale_datetime mst_property_last_sale_datetime,
edw_properties.neighborhood neighborhood,
lower(edw_properties.propertyaddress) property_address,
lower(edw_properties.propertyarchitecturestyle) property_architecture_style,
lower(edw_properties.propertycity) property_city,
lower(edw_properties.propertycountry) property_country,
edw_properties.propertydimkey property_dim_key,
edw_properties.property_estimated_value_double property_estimated_value,
edw_properties.propertyid property_id,
edw_properties.property_last_sale_price_double property_last_sale_price,
edw_properties.propertylatitude property_latitude,
edw_properties.propertylongitude property_longitude,
edw_properties.propertylotsquarefeet property_lot_square_feet,
edw_properties.property_number_of_bathrooms_double property_number_of_bath_rooms,
edw_properties.propertynumberofbedrooms property_number_of_bed_rooms,
edw_properties.property_number_of_stories_double property_number_of_stories,
edw_properties.propertypostalcode property_postal_code,
edw_properties.propertysquarefeet property_square_feet,
lower(edw_properties.propertystate) property_state,
edw_properties.property_tax_assessed_value_double property_tax_assessed_value,
edw_properties.property_tax_paid_amount_double property_tax_paid_amount,
edw_properties.propertytaxyear property_tax_year,
edw_properties.propertytype property_type,
edw_properties.propertyyearbuilt property_year_built,
edw_properties.propertyzoning property_zoning,
edw_properties.residentialneighborhood residential_neighborhood,
edw_properties.subneighborhood sub_neighborhood
FROM edw_properties 
left join property_dim_keys_historical on property_dim_keys_historical.property_dim_key = edw_properties.propertydimkey
WHERE edw_properties.row_number_seq = 1
AND COALESCE(property_dim_keys_historical.property_dim_key,'')=''
and edw_properties.effective_to_datetime_mst > '2023-01-01'