WITH edw_properties AS
(
select
row_number() OVER (PARTITION BY propertydimkey ORDER BY  effective_from_datetime_mst DESC, effective_to_datetime_mst  ASC) AS row_number_seq,
propertydimkey,
propertyid,
propertytype,
propertyyearbuilt,
propertysquarefeet,
propertylotsquarefeet,
propertyaddress,
propertycity,
propertystate,
propertypostalcode,
propertylatitude,
propertylongitude,
propertynumberofbedrooms,
propertynumberofbathrooms,
propertynumberofstories,
propertyarchitecturestyle,
propertytaxassessedvalue,
propertytaxyear,
propertytaxpaidamount,
propertyzoning,
propertyestimatedvalue,
isforeclosure,
propertyforeclosuredate,
propertylastsaledate,
propertylastsaleprice,
effectivefrom,
effectiveto,
propertycountry,
macroneighborhood,
neighborhood,
subneighborhood,
residentialneighborhood,
etl_ztg_id,
etl_source_partition_timestamp,
etl_create_date,
etl_last_update_timestamp,
etl_partition_key_timestamp,
etl_rd_arrival_year,
etl_rd_arrival_month,
etl_rd_arrival_day,
etl_rd_arrival_hour,
etl_source_filename,
etl_invalid_criticality_ind,
etl_dedupe_md5_checksum,
etl_datatype_processed_ind,
property_latitude_double,
property_longitude_double,
property_number_of_bathrooms_double,
property_number_of_stories_double,
property_tax_assessed_value_double,
property_tax_paid_amount_double,
property_estimated_value_double,
property_foreclosure_datetime,
property_last_sale_datetime,
property_last_sale_price_double,
effective_from_datetime_mst,
effective_to_datetime_mst
from
lstp_edw_pdt__property_dim
where effective_to_datetime_mst >= '2018-01-01'
and effective_to_datetime_mst < '2023-01-01'
)
SELECT
etl_create_date,
etl_datatype_processed_ind,
etl_dedupe_md5_checksum,
etl_invalid_criticality_ind,
etl_last_update_timestamp,
etl_partition_key_timestamp,
etl_rd_arrival_day,
etl_rd_arrival_hour,
etl_rd_arrival_month,
etl_rd_arrival_year,
etl_source_filename,
etl_source_partition_timestamp,
etl_ztg_id,
isforeclosure is_foreclosure,
macroneighborhood macro_neighborhood,
effective_from_datetime_mst mst_effective_from_datetime,
effective_to_datetime_mst mst_effective_to_datetime,
property_foreclosure_datetime mst_property_foreclosure_datetime,
property_last_sale_datetime mst_property_last_sale_datetime,
neighborhood neighborhood,
lower(propertyaddress) property_address,
lower(propertyarchitecturestyle) property_architecture_style,
lower(propertycity) property_city,
lower(propertycountry) property_country,
propertydimkey property_dim_key,
property_estimated_value_double property_estimated_value,
propertyid property_id,
property_last_sale_price_double property_last_sale_price,
propertylatitude property_latitude,
propertylongitude property_longitude,
propertylotsquarefeet property_lot_square_feet,
property_number_of_bathrooms_double property_number_of_bath_rooms,
propertynumberofbedrooms property_number_of_bed_rooms,
property_number_of_stories_double property_number_of_stories,
propertypostalcode property_postal_code,
propertysquarefeet property_square_feet,
lower(propertystate) property_state,
property_tax_assessed_value_double property_tax_assessed_value,
property_tax_paid_amount_double property_tax_paid_amount,
propertytaxyear property_tax_year,
propertytype property_type,
propertyyearbuilt property_year_built,
propertyzoning property_zoning,
residentialneighborhood residential_neighborhood,
subneighborhood sub_neighborhood
FROM edw_properties WHERE row_number_seq = 1